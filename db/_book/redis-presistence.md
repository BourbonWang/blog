# Redis 持久化

## 前言

持久化就是将内存中的数据保存到硬盘上，当发生故障时，数据可以从硬盘上恢复。持久化机制也可以用于拓展节点时完成主从同步。

Redis 提供了两种持久化机制：RDB快照，和AOF日志。

## RDB

RDB持久化是默认的持久化方式，在指定的时间间隔内将内存中的数据集快照写入磁盘。在进行数据持久化的过程中，会先将数据写入到一个临时文件中，待持久化过程都结束了，才会用这个临时文件替换上次持久化好的文件。正是这种特性，让我们可以随时来进行备份，因为快照文件总是完整可用的。

### 手动备份 BGSAVE

执行BGSAVE命令，会进行以下操作：

1. ，Redis父进程判断当前是否存在正在执行的子进程，如RDB/AOF子进程，如果存在，bgsave命令直接返回。
2. 父进程 fork 出一个子进程。fork的短暂时间内，父进程会阻塞；
3. 直到fork完成，bgsave命令返回“Background saving started”信息，并不再阻塞父进程，可以继续响应其他命令。此时父进程和子进程是共享内存的，如果父进程又得到了一个写命令，copy-on-write机制会复制出一个页副本来处理新的请求。
4. 子进程创建RDB文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。
5. 进程发送信号给父进程表示完成，父进程更新统计信息。

### 自动备份

可以通过配置设置自动做快照持久化的方式。我们可以配置redis在n秒内如果超过m个key被修改就自动执行BGSAVE，下面是默认的快照保存配置。

```redis
save 900 1     #900秒内如果超过1个key被修改，则发起快照保存
save 300 10    #300秒内容如超过10个key被修改，则发起快照保存
save 60 10000
```

如果从节点执行全量复制操作，主节点自动执行bgsave生成RDB文件并发送给从节点。执行shutdown命令时，如果没有开启AOF持久化功能，也会自动执行bgsave。

### 优点

- RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据快照。非常适用于备份，容灾等场景。
- Redis加载RDB恢复大型数据集远远快于AOF的方式。
- redis会单独创建一个子进程来进行持久化，而主进程是不会进行任何IO操作的，这样就确保了redis极高的性能。

### 缺点

RDB要保存整个数据集的文件，它并不是一个轻松的操作。可能至少5分钟后才会保存一次RDB文件。如果在一次RDB持久化之后的几分钟里发生宕机，那么这几分钟内写入的数据都将丢失。

## AOF

AOF，即Append Only File，只允许追加不允许改写的文件。AOF方式是将执行过的写指令记录下来，在数据恢复时按照从前到后的顺序再将指令都执行一遍。AOF解决了数据持久化的实时性，目前已经是Redis持久化的主流方式。恢复数据时，如果AOF持久化开启且存在AOF文件时，优先加载AOF文件。

默认的AOF持久化策略是每秒钟fsync一次（fsync是指把缓存中的写指令记录到磁盘中），因为在这种情况下，redis仍然可以保持很好的处理性能，即使redis故障，也只会丢失最近1秒钟的数据。

### 过程

1. 所有的写命令都追加到AOF缓冲区中。Redis使用单线程响应命令，如果每次写AOF文件命令都直接追加到硬盘，那么性能完全取决于当前硬盘负载。选择先写入缓冲区中，Redis可以提供多种缓冲区同步硬盘的策略，在性能和安全性方面做出平衡。
2. AOF缓冲区根据对应的策略向硬盘做同步操作。
3. 随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩的目的。重写的工作包括：
   - 清除已经超时的数据的写入命令；
   - 重写使用内存中的数据直接生成，这样新的AOF文件只保留最终数据的写入命令；
   - 将多条写命令合并成一个。
4. 重写时，父进程先fork出子进程，子进程对旧的AOF文件重写，生成新的AOF文件
5. 同时父进程仍然在响应其他的命令。如果在子进程重写的同时，父进程仍然有写命令，就将写命令加入AOF重写缓冲区中。
6. 子进程重写完旧的AOF文件后，将AOF重写缓冲区里的命令写入新的AOF文件。
7. 用新的AOF文件替换旧的。

### 触发重写

手动触发：直接调用bgrewriteaof命令。

自动触发：设置以下参数，超出后重写

- auto-aof-rewrite-min-size： AOF文件大小阈值，
- auto-aof-rewrite-percentage：当前AOF文件大小和上一次重写后AOF文件大小的比值
- appendfsync 每秒同步

### 优点

- AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次持久化操作，redis仍然可以保持很好的处理性能，即使redis故障，也只会丢失最近1秒钟的数据。
- 在进行AOF重写时，仍然是采用先写临时文件，全部完成后再替换的流程，所以断电、磁盘满等问题都不会影响AOF文件的可用性。
- AOF 文件有序地保存了对数据库执行的所有写入操作，文件的内容非常容易被人读懂， 对文件进行分析也很轻松。

### 缺点

- 对于同一份数据来说，AOF日志文件通常比RDB数据快照文件更大。
- AOF开启后，支持的写QPS会比RDB支持的写QPS低，因为AOF一般会配置成每秒fsync一次日志文件，当然，每秒一次时的性能也还是很高的
- 恢复速度不如RDB快。

## RDB和AOF的选择

如果希望获得最佳的性能，并且可以承受数分钟以内的数据丢失，那么可以只使用 RDB 持久化。

如果想得到更可靠的持久化方案， 你应该同时使用两种持久化功能。恢复时第一时间用RDB，然后用AOF做数据补全。



