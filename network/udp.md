# UDP详解

UDP是运输层的用户数据报协议，基于UDP的应用层协议有DNS，RIP等。

## 特点

- **无需建立连接。**发送方与接收方在传输数据之前不建立连接，发送方只是简单的把数据发送到网络上；接收方把收到的数据报放在队列中，供应用进程读取。UDP不会产生建立连接的时延，因此DNS采用UDP。
- **无连接状态**。TCP为保证可靠运输需要维护连接状态，包括序列号，窗口大小，缓存等参数。UDP不需要维护连接状态，也不需要跟踪这些参数。
- **尽最大努力交付。**应用进程只要将数据交给UDP，UDP就会立刻封装成数据报发送到网络中。吞吐量不受拥塞控制算法的调节，只受应用软件生成数据的速率、传输带宽、 源端和终端主机性能的限制。
- **不可靠运输**。UDP只是提供了运输层最基本的功能。没有确认应答、重传、拥塞控制、缓冲窗口等保证可靠运输的手段。简单网络管理协议SNMP使用UDP作为运输层，因为在网络重压情况下，可靠的、有拥塞控制的数据传输变得难以实现。
- **面向报文**。UDP将应用进程的报文，在添加首部后就向下交付给IP层。既不拆分，也不合并，而是保留这些报文的边界。 因此，应用程序需要选择合适的报文大小。
- **分组首部开销小**。UDP头只有8个字节。

## 报文

### 首部

- **16位源端口号**：UDP使用（目的IP，目的端口号）二元组来唯一标识进程。有相同的目的IP和目的端口号的报文，会被同一个套接字接收，并定向到相同的应用进程。在这个过程源端口号是没用的。但如果接收方要回复一个报文给发送方时，就可以直接将报文中的源端口号提取出来，作为目的端口号。

- **16位目的端口号**：多路分解时用于定位目的进程。

- **16位长度**：包括首部的UDP报文长度，以字节为单位。

- **16位检验和**：UDP检验和提供了差错检测功能，不能进行差错恢复。一些UDP会将错误报文丢弃，另一些UDP会警告应用进程。

  虽然链路层也提供了差错检测，但不能保证源与目的之间所有的链路都提供差错检测。另外，即使报文段被正确传输，在报文段存储在某路由器的内存中时，也可能出现比特差错。因此UDP提供了端到端的差错检测。

  发送方的UDP对全部的16比特字求和，溢出时回卷。然后将结果取反，作为检验和。比如，下面的数据：

  ```
  按16位排列
  0110011001100000
  0101010101010101
  1000111100001100
  前两行求和得到  1011101110110101
  与第三行求和：  1000111100001100
             + —————————————————
  溢出回卷，得到  0100101011000010
  将结果取反     1011010100111101
  ```

  于是就得到了检验和1011010100111101。接收方将包括检验和的4个16比特字按同样的方式求和。如果结果全是1，则分组没有差错；如果结果中出现了0，则分组出现了差错。

### 数据

对于DNS，数据要么包含一个查询报文，要么包含一个响应报文。对于流媒体应用，数据可以是媒体抽样。

## UDP和TCP的区别

- TCP面向连接，UDP是无连接的。
- TCP对系统资源的要求较多，UDP较少。由于UDP是无连接的，不需要保存连接的参数。TCP要为每个对等方分配资源建立连接，而UDP不需要，UDP只用一个套接字来接收和发送报文。
- TCP是面向字节流的，UDP是面向报文的。TCP的发送和接收都是将字节数据暂存到缓冲区，在合适的时间发送或交付给上层。UDP是将来自上层的数据直接打包成报文，立即发送。
- TCP提供可靠传输，包括确认应答机制，重传机制，流量控制，拥塞控制等。UDP不提供，可能会丢包。当然，开发者可以在应用层实现这些机制，从而可以进行可靠通信，而无需被TCP拥塞机制约束住传输速率。
- 也因此，UDP的报文比TCP简单。UDP头只需要8字节，TCP头有20-60字节。
- 由于有基于序列号的确认应答机制，TCP能保证数据的顺序。而UDP不提供，开发者只能在应用层自己实现这个功能。
- TCP对网络环境有拥塞控制机制，UDP没有。拥塞控制能保持网络的可用性，而降低传输的实时性能。在一些流媒体的场景比如视频会议、音频等，应用可以容忍一些分组的丢失，而传输的实时性则更加重要，UDP往往更适合这些应用。然而，如果网络中每个用户都传输高比特率视频，而没有任何的拥塞控制，路由器中就会有大量的分组溢出，以至于几乎没有UDP分组能成功传输到目的地。此外，路径上某处由UDP造成的大量丢包，会导致TCP发送方减小发送速率，甚至挤垮TCP会话。所以提出了另外的一些机制，如DCCP，让所有的数据源（包括UDP）执行自适应的拥塞控制。

