# 从输入URL到获得页面请求的全过程

## 输入URL

向地址栏中输入URL，浏览器会先检查URL，包括去除空格，非法字符等。

假如URL为：http://www.bourbon17.site/network/tcp.html

把URL分成协议、网络地址、资源路径三部分

- 协议：从该计算机获取资源的方式，有HTTP、HTTPS、FTP等，不同协议有不同的通讯内容格式，如果没有，则自动补全`http://`
- 网络地址：指连接网络上的哪一台计算机，可以是域名、IP地址，可以包括端口号。如：`www.bourbon17.site`
- 资源路径：指从服务器上获取哪一项资源。如 `/network/tcp.html`

## 域名解析

如果URL中的网络地址直接是IP+端口号（如果省略端口号，则是HTTP默认80端口），就可以直接建立连接；如果是域名，就需要先进行域名解析，就是根据域名寻找对应的IP地址。

假如解析`www.bourbon17.site`，浏览器会依次进行以下查找：

1. 从浏览器缓存里查找对应的IP，因为浏览器会缓存DNS记录一段时间
2. 如果没找到，从系统hosts文件中查找
3. 如果没找到，从路由器缓存查找，路由器通常有自己的DNS缓存
4. 如果没找到，发送DNS请求到本地DNS服务器，然后从本地DNS缓存差找。本地DNS服务器通常与主机在同一个局域网中，或者相隔不过几个路由器
5. 如果没找到，本地DNS服务器开始进行递归或迭代搜索。从根DNS服务器开始，顶级域服务器，权威DNS服务器······依次查找。比如查找`www.cqu.edu.cn`的IP地址：先从根DNS服务器查找，然后去`.cn`顶级域服务器，然后去`.edu`二级域名服务器，然后`.cqu`······这样从域名的右边向左依次搜索，最终找到了对应的IP地址。前面的DNS服务器返回的都是接下来应该查询的DNS服务器的IP地址，最终的权威服务器将返回域名对应的IP。当然，每个DNS服务器都设有缓存，如果缓存命中，就可以直接返回结果。

![](https://s3.ax1x.com/2021/01/31/yEyKXQ.png)

## 建立连接

### 应用层

将域名转换成IP地址后，就可以正常进行HTTP请求了，发送HTTP报文。

### 运输层

HTTP使用TCP作为运输层协议，提供端到端的可靠数据传输。

首先通过三次握手与服务器建立连接。

然后将应用层的数据读入缓存，即HTTP报文。按MSS分割成若干的TCP报文，发送到网络层。

之前的DNS使用UDP，直接将报文发送到网络层。

###  网络层

网络层通过IP地址找到对应的主机。

首先将运输层报文套上IP报头，包括源IP、目标IP、TTL、首部检验和等，就成了IP数据报。

然后计算机将目标IP地址与子网掩码进行与运算，来判断是否目标IP与本机是否在同一子网下。如果在同一子网，就可以直接通信；如果不在，说明目标IP在外部的网络中，就需要通过网关将数据报发送出去。

从网关转发出口后，通过路由器一步一步的跳转。路由器内部维护了路由表，包括目标地址、子网掩码、网关、

接口等几项。路由器将目标IP与表中每个条目的子网掩码进行与运算，得到的结果与对应条目的目标地址进行匹配，如果匹配就会作为候选转发目标，如果不匹配就继续尝试下个条目。如果没有能匹配的，就选择默认路由0.0.0.0。

然后路由器检查该条目的网关一项。如果网关的内容是一个IP地址，说明这时下一跳的路由器IP地址；如果网关为空，说明该条目的目标地址就是最终的目的IP了。然后将数据报转发到条目对应的接口上就可以转发出去了。

![](https://pic2.zhimg.com/v2-4ea3e321b489f464d31101bff5630547_r.jpg?source=1940ef5c)

链路层对传输单元的大小有限制，一个链路层帧能承载的最大数据量叫最大传输单元MTU。当MTU比IP数据报的长度要小，就需要对IP数据报分片，分出的片也要加上IP报头，变成更小的IP数据报。由于每个链路的MTU可能不同，在MTU变小时，路由器也会将IP数据报继续分片。但路由器在收到众多分片后并不会组装，只有最终的目标设备才会组装所有的IP分片。

### 链路层

链路层提供了网络路径上节点间的可靠传输。链路层上的设备通过MAC地址唯一标识，即物理地址。每张网卡，路由器的每个端口都有独特的MAC地址。

同样的，在IP数据报外面套上MAC头部，包括源MAC地址、目标MAC地址等，就成了帧。发送方的MAC地址可以直接从设备读取；接收方的MAC地址需要通过路由表中查询结果的IP得到。从IP到MAC的转换使用ARP协议。ARP会先检查缓存是否记录了IP对应的MAC地址。如果缓存里没有，就在网络中广播，询问这个IP对应的MAC是谁，然后对应IP的设备会回应自己的MAC，这样本机就得到了目标IP对应的MAC了。

linux使用`arp -a`查看ARP缓存

![](https://s3.ax1x.com/2021/01/31/yVpUnU.png)

链路层的帧只提供节点到节点的传输，比如从计算机到路由器，路由器到路由器。帧从源MAC地址对应的网卡发送到网络，然后到达下一跳路由器后，就会解包。路由器会检查这个帧的MAC地址是否属于自己，如果不是，就直接丢弃。解包后，MAC的任务就完成了，路由器得到了IP数据报，才能进行网络层的转发等操作。

在网络传输的过程中，源IP和目标IP始终是不会变的，一直变化的是MAC地址，因为需要MAC地址在以太网内进行两个设备之间的传输。

## 服务器处理

服务器最终收到了数据。从链路层依次向上分解，组装若干IP分片，再分解出运输层报文，通过端口号找到进程，存到TCP连接的缓存中。当所有TCP报文都收到后，TCP将报文内容按序组装，得到浏览器发来的HTTP报文，交付给网站的后台程序。

后台解析HTTP请求，通过资源路径找到对应的资源，或者找到对应的处理函数。然后解析请求中的参数、请求体等，做出相应的处理（查询数据库，组装HTML等）。将数据写入HTTP response，按同样的方式经过网关、路由器等返回给浏览器。

## 浏览器处理

然后浏览器收到了来自服务器的响应，内容就是URL对应的HTML页面。浏览器在解析HTML时，会自上而下加载，并在加载过程中进行解析渲染，生成DOM节点。在解析过程中，如果遇到请求外部资源时，如图片、外链的CSS等，会继续发送请求。请求过程是异步的，并不会影响HTML的加载。